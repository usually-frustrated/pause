name: Update Major Version Tag

on:
  release:
    types: [published]

jobs:
  update-major-tag:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Update major version tag
        run: |
          # Extract version from release tag (e.g., v2.1.0 -> v2)
          TAG="${{ github.event.release.tag_name }}"

          if [[ ! "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "‚ö†Ô∏è  Tag $TAG doesn't match semver pattern (vX.Y.Z), skipping"
            exit 0
          fi

          MAJOR_VERSION=$(echo "$TAG" | cut -d. -f1)

          echo "üìå Release tag: $TAG"
          echo "üìå Major version: $MAJOR_VERSION"

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Delete existing major version tag if it exists
          if git rev-parse "$MAJOR_VERSION" >/dev/null 2>&1; then
            echo "üóëÔ∏è  Deleting existing $MAJOR_VERSION tag"
            git tag -d "$MAJOR_VERSION"
            git push origin ":refs/tags/$MAJOR_VERSION" || true
          fi

          # Create new major version tag pointing to this release
          echo "‚ú® Creating $MAJOR_VERSION tag pointing to $TAG"
          git tag "$MAJOR_VERSION" "$TAG"
          git push origin "$MAJOR_VERSION" --force

          echo "‚úÖ Users on @$MAJOR_VERSION will now get $TAG"
